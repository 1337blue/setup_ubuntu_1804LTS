- name: Setup working environment
  hosts: localhost
  vars:
    slack_version: 4.0.0
    repos:
      enpass: deb https://apt.enpass.io/ stable main
      opera-stable: deb [arch=i386,amd64] https://deb.opera.com/opera-stable/ stable non-free
      vscode: deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main

  tasks:
    - name: Install Packages
      apt:
        name: "{{ packages }}"
      vars:
        packages:
        - awscli
        - docker-compose
        - docker.io
        - jq
        - software-properties-common 
        - apt-transport-https
        - wget
        - net-tools
        - vim
        - xvnc4viewer
        - htop
        - tree
        - iotop
        - virtualbox
        - linux-headers-generic

    # vagrant depends on virtualbox
    - name: Install Vagrant
      apt:
        name: vagrant

    - name: Import GPG keys
      apt_key:
        url: "{{ item }}"
      with_items:   
        - https://packages.microsoft.com/keys/microsoft.asc
        - https://deb.opera.com/archive.key
        - https://apt.enpass.io/keys/enpass-linux.key
 
    - name: Add apt repos 
      apt_repository:
        repo: "{{ item.value }}"
        filename: "{{ item.key }}"
      loop: "{{ lookup ('dict', repos) }}"
            
    - name: Install non standard packages
      apt:
        name: "{{ item.key }}"
      when: not item.key == "vscode"
      loop: "{{ lookup ('dict', repos) }}"

    - name: Install the special kid
      apt:
        name: code

    - name: Get installed Slack version
      shell: slack -v
      register: slack_version_installed

    - name: Install Slack
      when: not slack_version == slack_version_installed.stdout
      apt:
        deb: https://downloads.slack-edge.com/linux_releases/slack-desktop-{{ slack_version }}-amd64.deb
    
    - name: fetch VS Code extensions
      become: yes
      become_user: ubuntu
      shell: code --list-extensions
      register: vs_code_extensions

    - name: Install VS Code extensions
      become: yes
      become_user: ubuntu
      shell: code --install-extension "{{ item }}"
      when: item not in vs_code_extensions.stdout
      with_items:
      - DavidAnson.vscode-markdownlint
      - dbaeumer.vscode-eslint
      - eamodio.gitlens 
      - HookyQR.beautify
      - janjoerke.jenkins-pipeline-linter-connector
      - jmMeessen.jenkins-declarative-support
      - magicstack.MagicPython
      - mauve.terraform
      - mhutchie.git-graph
      - ms-python.python
      - ms-azuretools.vscode-docker
      - redhat.vscode-yaml
      - teledemic.branch-warnings
      - tht13.python
      - vscodevim.vim

    - name: Increase watch limit for VSCode
      lineinfile:
        path: /etc/sysctl.conf
        state: present
        line: fs.inotify.max_user_watches=524288
